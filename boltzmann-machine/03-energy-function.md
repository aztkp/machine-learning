# 3. エネルギー関数

## エネルギーベースモデルの考え方

ボルツマンマシンは**エネルギーベースモデル**です。

核心的なアイデア：
> 「良いパターン」= 低エネルギー状態
> 「悪いパターン」= 高エネルギー状態

学習とは、訓練データに対応する状態のエネルギーを下げ、それ以外のエネルギーを上げることです。

## エネルギー関数の定義

### 一般形

$$E(\mathbf{s}) = -\sum_{i<j} w_{ij} s_i s_j - \sum_i b_i s_i$$

展開すると：

```
E = - (ユニット間の相互作用の和) - (バイアスの和)
```

### 行列表記

$$E(\mathbf{s}) = -\frac{1}{2}\mathbf{s}^T \mathbf{W} \mathbf{s} - \mathbf{b}^T \mathbf{s}$$

- $\mathbf{W}$: 重み行列（対称、対角成分は0）
- $\mathbf{b}$: バイアスベクトル
- $\mathbf{s}$: 状態ベクトル

## エネルギーの直感的理解

### 相互作用項

$$-w_{ij} s_i s_j$$

| $w_{ij}$ | $s_i, s_j$ | 寄与 | 解釈 |
|----------|------------|------|------|
| 正 (+) | 同じ (1,1) or (0,0)* | 負（エネルギー減少） | 協調→安定 |
| 正 (+) | 異なる (1,0) or (0,1)* | 0 | - |
| 負 (-) | 同じ | 正（エネルギー増加） | 協調→不安定 |
| 負 (-) | 異なる | 0 | - |

*注: {0,1}表現の場合。{-1,+1}表現では異なります。

### バイアス項

$$-b_i s_i$$

- $b_i > 0$: ユニット $i$ が活性化（$s_i=1$）しやすい
- $b_i < 0$: ユニット $i$ が非活性（$s_i=0$）しやすい

## 具体例で理解する

### 例1: 2ユニットのシステム

```
ユニット: s₁, s₂
重み: w₁₂ = 2
バイアス: b₁ = 0, b₂ = 0
```

エネルギー計算（{0,1}表現）：

| $s_1$ | $s_2$ | $E = -2 s_1 s_2$ |
|-------|-------|------------------|
| 0 | 0 | 0 |
| 0 | 1 | 0 |
| 1 | 0 | 0 |
| 1 | 1 | **-2** (最低) |

→ 両方活性化した状態が最も安定

### 例2: 3ユニットで三角形接続

```
    s₁
   /  \
  /    \
s₂ ---- s₃

w₁₂ = 1, w₁₃ = 1, w₂₃ = -1
```

この設定では、s₂とs₃は「反発」し合います（負の重み）。

## 可視・隠れユニットを分離した表現

可視ユニット $\mathbf{v}$ と隠れユニット $\mathbf{h}$ を明示すると：

$$E(\mathbf{v}, \mathbf{h}) = -\mathbf{v}^T \mathbf{W} \mathbf{h} - \mathbf{b}^T \mathbf{v} - \mathbf{c}^T \mathbf{h} - \mathbf{v}^T \mathbf{U} \mathbf{v} - \mathbf{h}^T \mathbf{V} \mathbf{h}$$

- $\mathbf{W}$: 可視-隠れ間の重み
- $\mathbf{U}$: 可視-可視間の重み
- $\mathbf{V}$: 隠れ-隠れ間の重み
- $\mathbf{b}$: 可視ユニットのバイアス
- $\mathbf{c}$: 隠れユニットのバイアス

## 自由エネルギー

隠れユニットを周辺化した**自由エネルギー**：

$$F(\mathbf{v}) = -\log \sum_{\mathbf{h}} e^{-E(\mathbf{v}, \mathbf{h})}$$

これを使うと、可視ユニットの確率は：

$$P(\mathbf{v}) = \frac{e^{-F(\mathbf{v})}}{Z}$$

### 自由エネルギーの解釈

$$F = \langle E \rangle - T \cdot S$$

- $\langle E \rangle$: 平均エネルギー
- $S$: エントロピー（状態の多様性）
- $T$: 温度

低い自由エネルギー = 低エネルギー or 高エントロピー（多くの状態が可能）

## エネルギー地形

エネルギー関数は「地形」として視覚化できます：

```
エネルギー
    ^
    |     /\        /\
    |    /  \  /\  /  \
    |   /    \/  \/    \
    |  /                \
    | /      ★          \
    |/_______↓___________\___ 状態空間
           低エネルギー
           （安定状態）
```

### 局所最小値と大域最小値

- **局所最小値**: 周辺より低いが、最低ではない
- **大域最小値**: 全体で最もエネルギーが低い

確率的な更新により、局所最小値から抜け出せる可能性があります。

## エネルギーと対数尤度

訓練データの対数尤度：

$$\log P(\mathbf{v}) = -F(\mathbf{v}) - \log Z$$

学習の目標は $\log P(\mathbf{v})$ を最大化すること。これは：

1. 訓練データの自由エネルギー $F(\mathbf{v})$ を**下げる**
2. 分配関数 $\log Z$ を**下げる**（≒ 他の状態のエネルギーを上げる）

## 勾配の導出

パラメータ $\theta$（重み $w_{ij}$ やバイアス $b_i$）に関する勾配：

$$\frac{\partial \log P(\mathbf{v})}{\partial \theta} = -\left\langle \frac{\partial E}{\partial \theta} \right\rangle_{data} + \left\langle \frac{\partial E}{\partial \theta} \right\rangle_{model}$$

- 第1項（正相）: データが与えられた下での期待値
- 第2項（負相）: モデル分布からの期待値

この2つの期待値の差が学習の勾配となります。

---

[← 前へ: 基礎理論](./02-basics.md) | [次へ: 学習アルゴリズム →](./04-learning.md)
